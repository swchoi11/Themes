# Themes

## 소개
### 목적
* easy parser의 ocr, yolo기반 컴포넌트 감지 부분의 단점을 보완하기 위해 이미지의 xml 구조를 활용하여 컴포넌트 감지
* xml 파일에 있는 컴포넌트별 리소스 정보를 활용하여 rule based 이미지 처리 모듈 구현
* 제미나이를 활용한 이미지 처리 모듈의 기능 보완

### 수행기간
* 1차 베이스라인 구현 : 2025.05.27. ~ 2025.06.04.
* 2차 고도화 : 2025.06.04. ~ 2025.06.13.

## 개요
### 전제 조건
* 디폴트 또는 정상 테마의 파일이 레이블링되어 존재해야함 
* 이미지에 해당하는 xml파일이 함께 존재해야함

#
### 처리 과정

#### 0. 데이터 준비 및 전처리
* API 키 설정 및 테스트 이미지 리스트 로드(병렬처리를 위함)
* json 파일 초기화 및 유효한 테스트 리스트 검증(중단 지점부터 재실행해야할 시를 위한 장애 대응)
* 예외 처리(XML 파일 없음, 유효하지 않은 이미지, 이미지 사이즈 검증)

#### 1. 분류 (classification)
* **1-1. 1차 분류**: 파일명을 기반으로 default, pass 이미지에 대한 그룹화
* 동일한 prefix가 붙은 이미지를 폴더링
* 파일명 정규화를 통한 그룹 생성
* **1-2. 2차 분류**: XML 유사도 기반 세부 그룹화
* 동일한 prefix가 붙은 이미지에 대한 xml 유사도를 기반으로 한 분류
* 유사도 임계값(90%)를 넘은 파일들을 같은 서브 그룹으로 분류

#### 2. 레이아웃 검증 (layout)
XML 구조 안에서 이슈 모듈과 관련 있는 레이아웃인지 검증:

관련 있는 레이아웃이라면 해당 이슈를 검증함.

* **텍스트 컴포넌트가 있는 경우** :
가독성 검증`(3-1)`
* **라디오버튼 컴포넌트가 있는 경우** :
아이콘 잘림 검증 `(3-2)`
* **아이콘 컴포넌트가 있는 경우** :
아이콘 잘림 검증 `(3-2)`, 정렬`(3-3)`, 중복 아이콘 검증`(3-4)`
* **기타(시계 아이콘, 달력 아이콘 등이 있는 경우)** :
레이아웃 이슈 검증 `(4-1)`

#### 3. 이슈 검증 (issue)

**`3-1`. 가독성 검증** (src/issue/visibility.py)
* 고채도, 저채도 사진 분류 
* 채도 분류에 맞는 색공간을 사용한(hsv 또는 lab) 주요 색상 추출
* 주요 색상이 3가지가 되지 않는 경우 클러스터링을 통한 색상 추출
* 3가지 색의 상호 비교를 통한 색 대비 검증 -> 1가지 조합만 유의미한 대비여도 ok

**`3-2`. 아이콘 잘림 이슈 검증** (src/issue/cutoff.py)
* 사진의 캐니 변환을 통한 엣지 검출
* 엣지에서 직선 라인이 일정 길이 이상 검출되는지 확인
* 일정 길이 이상 검출되면 이상한 직선이 검출된 잘린 아이콘으로 검증

**`3-3`. 정렬 검증** (src/issue/alignment.py)
* 화면의 수평, 수직 길이의 절반 이하가 되는 컴포넌트만 추출 
* 해당 컴포넌트에 대한 포함 관계 정리
* 컴포넌트의 위치에 따른 수평 구간 추출 및 동일 구간에 대한 컴포넌트 그룹핑
* 그룹 내의 컴포넌트 바운딩박스 정보를 제미나이에게 제출 -> 정렬 여부 검증

**`3-4`. 동일한 아이콘 검증** (src/issue/icon.py)
* 화면에서 아이콘 크기의 컴포넌트만 추출
* 해당 컴포넌트와 동일한 이미지가 있는지 검증
* 동일한 이미지가 있다면 99% 이상 일치하는 정상 이미지 추출
* 정상 이미지에서도 동일한 이미지가 검출되는지 확인 -> 동일하다면 이슈 아님, 아니면 이슈

#### 4. Gemini 검증

**`4-1`. 레이아웃 이슈 검증**

달력아이콘, 시계아이콘이 있는 경우에 대해서
* 달력 아이콘에 요일 글자가 테두리를 벗어났는지
* 달력 아이콘의 날짜 글자가 상단바의 요일 정보와 다른지
* 시계 아이콘에서 시간 아이콘이 상단의 시간 정보와 다른지

전체 컴포넌트에 대해서
* 상호작용 요소에 대한 가독성 이슈의 추가 검증

**`4-2`. 이슈 점수 계산**
* 각 검출된 이슈에 대해 Gemini를 활용한 심각도 점수 부여
* 이슈 설명(description) 개선 및 상세화

#### 5. 종합 및 결과 산출

**5-1. 이슈 정렬 및 분류**
* 파일별 이슈그룹화
* 이슈 타입별 분류
* 심각도에 따른 정렬

**5-2. 최종 결과 산출**
* Excel 파일로 결과 출력
* JSON 형태로 중간 결과 저장
* 예외처리 결과 csv 저장

#
## 폴더 구조

```bash
.
├── README.md
├── main.py # 메인 실행 파일
├── output/ # 결과 출력 디렉토리
│ ├── classification/ # 분류 결과
│ ├── excels/ # Excel 결과 파일
│ ├── jsons/ # JSON 결과 파일
│ ├── images/ # 중간 산출 이미지 파일
│ └── exception.csv # 예외 처리 결과
├── src/
│ ├── utils/ # 유틸리티 모듈
│ │ ├── detect.py # 컴포넌트 감지
│ │ ├── logger.py # 로깅
│ │ ├── model.py # 데이터 모델
│ │ ├── prompt.py # Gemini 프롬프트
│ │ ├── utils.py # 공통 유틸리티
│ │ ├── bucket.py # 클라우드 스토리지
│ │ └── exceptions.py # 예외 처리
│ ├── issue/ # 이슈 검증 모듈
│ │ ├── alignment.py # 정렬 검증
│ │ ├── cutoff.py # 아이콘 잘림 검증
│ │ ├── icon.py # 아이콘 중복 검증
│ │ └── visibility.py # 가독성 검증
│ ├── classification.py # 이미지-XML 분류
│ ├── layout.py # 레이아웃 검증
│ └── gemini.py # Gemini 분석
└── .gitignore
```